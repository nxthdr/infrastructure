# Peerlab BGP Configuration
# Static filter and protocol definitions

# Include dynamic IP->ASN mapping (generated by peerlab-bird-config)
include "/etc/bird/peerlab-map.conf";

# Filter for peerlab imports with ASN verification
filter enforce_user_asn {
    int expected_asn;

    # Lookup expected ASN for this neighbor
    expected_asn = get_user_asn(from);

    # Reject if no mapping found
    if (expected_asn = 0) then {
        print "REJECT: neighbor not in allowed user list ", from;
        reject;
    }

    # Validate remote ASN
    if (bgp_path.last != expected_asn) then {
        print "REJECT: ASN ", bgp_path.last, " does not match assigned ASN ", expected_asn, " for ", from;
        reject;
    }

    print "ACCEPT: AS", bgp_path.last, " prefix ", net, " from ", from;
    accept;
}

# Filter for exports to peerlab - send them the full table
filter PeerlabExportFilter {
    # Export our own prefix
    if (net ~ [ 2a06:de00:50::/48 ]) then {
        accept;
    }
    # Export all learned routes (they'll see the full routing table)
    if (source = RTS_BGP) then {
        accept;
    }
    reject;
}

# Dynamic BGP template for peerlab connections
template bgp peerlab_template {
    local 100.64.0.2 as 215011;

    # Allow connections from non-directly connected IPs (via Tailscale)
    multihop;

    # IPv4 channel - only for BGP session establishment, no routes exchanged
    ipv4 {
        import none;
        export none;
        extended next hop on;
    };

    # IPv6 channel - exchange IPv6 routes over the IPv4 BGP session
    ipv6 {
        import keep filtered;
        import filter enforce_user_asn;
        export filter PeerlabExportFilter;
        extended next hop on;
    };

    # Connection settings
    hold time 90;
    keepalive time 30;
}

# Dynamic BGP protocol - accepts connections from peerlab participants via Tailscale
protocol bgp peerlab from peerlab_template {
    # Each participant gets their own dynamic session
    dynamic name "peerlab_";
    dynamic name digits 5;

    # Accept connections from Tailscale range (100.64.0.0/10)
    neighbor range 100.64.0.0/10 external;
}
