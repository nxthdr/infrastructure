# Peerlab BGP Configuration
# Static filter and protocol definitions

# Include dynamic IP->ASN mapping (generated by peerlab-bird-config)
include "/etc/bird/peerlab-map.conf";

# Filter for peerlab imports with ASN and prefix verification
filter enforce_user_asn_and_prefix {
    enforce_user_policy(from);
}

# Filter for exports to peerlab - send them the full table
filter PeerlabExportFilter {
    # Export our own prefix
    if (net ~ [ 2a06:de00:50::/48 ]) then {
        accept;
    }
    # Export all learned routes (they'll see the full routing table)
    if (source = RTS_BGP) then {
        accept;
    }
    reject;
}

# Dynamic BGP template for peerlab connections
template bgp peerlab_template {
    local {{ tailscale_ip }} as 215011;

    # Allow connections from non-directly connected IPs (via Tailscale)
    multihop;

    # IPv4 channel - only for BGP session establishment, no routes exchanged
    ipv4 {
        import none;
        export none;
        extended next hop on;
    };

    # IPv6 channel - exchange IPv6 routes over the IPv4 BGP session
    ipv6 {
        import keep filtered;
        import filter enforce_user_asn_and_prefix;
        export filter PeerlabExportFilter;
        extended next hop on;
    };

    # Connection settings
    hold time 90;
    keepalive time 30;
}

# Dynamic BGP protocol - accepts connections from peerlab participants via Tailscale
protocol bgp peerlab from peerlab_template {
    # Each participant gets their own dynamic session
    dynamic name "peerlab_";
    dynamic name digits 5;

    # Accept connections from Tailscale range (100.64.0.0/10)
    neighbor range 100.64.0.0/10 external;
}
