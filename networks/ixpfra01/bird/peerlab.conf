# BIRD Configuration for Peering Course
# Dynamic BGP template for peerlab connections via Tailscale

# Filter for peerlab imports - accept their prefixes
filter PeerlabImportFilter {
    # Accept routes from private AS ranges (peerlab participants)
    if (bgp_path.last >= 64512 && bgp_path.last <= 65534) then {
        print "Accepting peerlab route: ", net, " from AS", bgp_path.last;
        accept;
    }
    # Also accept from 4-byte private ASN range
    if (bgp_path.last >= 4200000000 && bgp_path.last <= 4294967294) then {
        print "Accepting peerlab route: ", net, " from AS", bgp_path.last;
        accept;
    }
    reject;
}

# Filter for exports to peerlab - send them the full table
filter PeerlabExportFilter {
    # Export our own prefix
    if (net ~ [ 2a06:de00:50::/48 ]) then {
        accept;
    }
    # Export all learned routes (they'll see the full routing table)
    if (source = RTS_BGP) then {
        accept;
    }
    reject;
}

# Dynamic BGP template for peerlab connections
template bgp peerlab_template {
    local 100.64.0.2 as 215011;

    # Allow connections from non-directly connected IPs (via Tailscale)
    multihop;

    # IPv4 channel - only for BGP session establishment, no routes exchanged
    ipv4 {
        import none;
        export none;
        extended next hop on;
    };

    # IPv6 channel - exchange IPv6 routes over the IPv4 BGP session
    ipv6 {
        import keep filtered;
        import filter PeerlabImportFilter;
        export filter PeerlabExportFilter;
        extended next hop on;
    };

    # Connection settings
    hold time 90;
    keepalive time 30;
}

# Dynamic BGP protocol - accepts connections from peerlab participants via Tailscale
# The 'range' directive allows any IP in the Tailscale range to connect
protocol bgp peerlab from peerlab_template {
    # This will accept connections from any Tailscale IP
    # Each participant gets their own dynamic session named peerlab_XXXXX
    dynamic name "peerlab_";
    dynamic name digits 5;

    # Accept connections from Tailscale range (100.64.0.0/10)
    # Participants can use any private ASN (external means any AS different from local AS)
    neighbor range 100.64.0.0/10 external;
}
